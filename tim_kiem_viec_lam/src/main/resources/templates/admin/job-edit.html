<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title th:text="'Công việc ' + ${job.id}"></title>

    <link rel="icon" type="image/png" sizes="16x16" href="/image/favicon-16x16.png">

    <!-- Link google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;400;500;700;900&amp;display=swap"
          rel="stylesheet">

    <!-- Link bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- Link icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
          integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
          crossorigin="anonymous" referrerpolicy="no-referrer">

    <!--    toastr.js-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
          integrity="sha512-vKMx8UnXk60zUwyUnUPM3HbQo8QfmNx7+ltw8Pm5zLusl1XIfwcxo8DbWCqMGKaWeNxWA8yrx5v3SaVpMvR3CA=="
          crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- Components CSS -->

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">


    <!-- Link tự viết -->
    <link rel="stylesheet" type="text/css" th:href="@{/css/style-admin.css}">
</head>

<body>
<!--HEADER-->
<div class="header">
    <div class="logo">
        <a href="/">
            <img th:src="@{/img/techjobs_bgw.png}" style="width: 100px" alt="logo">
        </a>
    </div>

    <div class="sidebar ms-5">
        <div class="menu">
            <ul>
                <li class="menu-item">
                    Quản lý công việc <span><i class="fa-solid fa-caret-down"></i></span>

                    <ul class="sub-menu">
                        <li class="sub-menu-item">
                            <a href="/recruiter/jobs">Danh sách công việc</a>
                        </li>
                        <li class="sub-menu-item">
                            <a href="/recruiter/jobs-create">Tạo công việc</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- BODY -->
<div class="job-container mt-4 mb-4">
    <div class="container">
        <div class="mb-4">
            <a href="/recruiter/jobs" class="btn-custom btn-refresh">
                <span><i class="fa-solid fa-angle-left"></i></span>
                Quay lại
            </a>
        </div>

        <div class="job-list-inner p-2">
            <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active fw-bold" id="job-tab" data-bs-toggle="tab" data-bs-target="#job"
                            type="button" role="tab" aria-controls="job" aria-selected="true">Chi tiết công
                        việc
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold" id="applicant-tab" data-bs-toggle="tab"
                            data-bs-target="#applicant" type="button" role="tab" aria-controls="applicant"
                            aria-selected="false">Danh sách ứng viên
                    </button>
                </li>
            </ul>
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="job" role="tabpanel" aria-labelledby="job-tab">
                    <div class="d-flex justify-content-between mb-4">
                        <button class="btn-custom btn-update-job" id="updateJobButton">
                            <span><i class="fa-solid fa-plus"></i></span>
                            Cập nhật
                        </button>
                        <button class="btn-custom btn-delete-job bg-danger">
                            <span><i class="fa-solid fa-trash-can"></i></span>
                            Xóa
                        </button>
                    </div>
                    <div class="row" id="update-form">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <input type="hidden" id="jobId" name="jobId">
                                <label for="name" class="form-label">Công ty</label>
                                <input th:value="${job.recruiter.name}" type="text" class="form-control" id="name"
                                       name="name">

                            </div>
                            <div class="mb-3">
                                <label for="title" class="form-label">Tên công việc</label>
                                <input th:value="${job.title}" type="text" class="form-control" id="title" name="title">
                            </div>
                            <div class="mb-3">
                                <label for="dueDateTime" class="form-label">Hạn nộp</label>
                                <input th:value="${job.dueDateTime}" type="date" class="form-control" id="dueDateTime"
                                       name="dueDateTime">
                            </div>
                            <div class="mb-3">
                                <label for="location" class="form-label">Địa chỉ</label>
                                <input th:value="${job.location}" type="text" class="form-control" id="location"
                                       name="location">
                            </div>
                            <div class="mb-3">
                                <label for="jobStatus" class="form-label">Trạng thái</label>
                                <select type="text" class="form-control" id="jobStatus" name="jobStatus">
                                    <option>OPEN</option>
                                    <option>ONGOING_INTERVIEWS</option>
                                    <option>HIRED</option>
                                    <option>CLOSED</option>
                                    <option>CANCELLED</option>
                                </select>

                            </div>
                            <div class="mb-3">
                                <label for="yoe" class="form-label">Kinh nghiệm</label>
                                <input th:value="${job.yoe}" type="number" class="form-control" id="yoe" name="yoe">
                            </div>
                            <div class="mb-3">
                                <label for="skill" class="form-label">Kỹ năng</label>
                                <select id="skill" class="form-control" multiple="multiple" name="skill">
                                    <option value="Javascript">Javascript</option>
                                    <option value="Java">Java</option>
                                    <option value="Golang">Golang</option>
                                    <option value="PHP">PHP</option>
                                    <option value="React">React</option>
                                    <option value="AWS">AWS</option>
                                    <option value="Devops">Devops</option>
                                    <option value=".Net">.Net</option>
                                    <option value="Vue">Vue</option>
                                    <option value="Angular">Angular</option>
                                    <option value="Python">Python</option>
                                    <option value="C#">C#</option>
                                    <option value="SQL">SQL</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="salaryFrom" class="form-label">Mức lương từ</label>
                                <input th:value="${job.salaryFrom}" type="text" class="form-control" id="salaryFrom"
                                       name="salaryFrom">
                            </div>
                            <div class="mb-3">
                                <label for="salaryTo" class="form-label">đến</label>
                                <input th:value="${job.salaryTo}" type="text" class="form-control" id="salaryTo"
                                       name="salaryTo">
                            </div>
                            <div class="mb-3">
                                <label for="literacy" class="form-label">Trình độ học vấn</label>
                                <select th:value="${job.literacy}" type="text" class="form-control" id="literacy"
                                        name="literacy">
                                    <option>UNIVERSITY</option>
                                    <option>COLLEGE</option>
                                    <option>INTERMEDIATE</option>
                                    <option>NONE</option>
                                </select>
                            </div>

                        </div>
                        <div class="col-md-9">
                            <div class="mb-3">
                                <label for="benefit" class="form-label">Phúc lợi</label>
                                <textarea th:text="${job.benefit}" rows="10" class="form-control" id="benefit"
                                          name="benefit"
                                ></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="detail" class="form-label">Mô tả công việc</label>
                                <textarea th:text="${job.detail}" rows="10" type="text" class="form-control" id="detail"
                                          name="detail"
                                ></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="requirement" class="form-label">Yêu cầu công việc</label>
                                <textarea th:text="${job.requirement}" rows="10" type="text" class="form-control"
                                          id="requirement" name="requirement"
                                ></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="applicant" role="tabpanel" aria-labelledby="applicant-tab">

                    <table class="table applicant-table">
                        <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên ứng viên</th>
                            <th>Mô tả ngắn</th>
                            <th>Link CV</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>1</td>
                            <td>Noah Lott</td>
                            <td class="w-50">Deleniti
                            </td>
                            <td><a href="" target="_blank">Xem chi tiết</a></td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Penny Bunn</td>
                            <td class="w-50">Qui
                            </td>
                            <td><a href="" target="_blank">Xem chi tiết</a></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- axios -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<!--  toastr.js-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
        integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="/js/main.js"></script>
<!-- Components JS -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    window.onload = function () {
        const jwtToken = localStorage.getItem("jwtToken");

        if (!jwtToken) {
            // Chưa đăng nhập, chuyển hướng về trang đăng nhập
            window.location.href = "http://localhost:8080/splash";
        } else {
            // lấy ra roles ở dạng string
            const userInfomation = JSON.parse(localStorage.getItem("userInfomation"));
            const userRoles = userInfomation.roles[0];
            console.log(userRoles)


            // Kiểm tra vai trò và chuyển hướng người dùng
            const pathName = window.location.pathname;

            // chỉ admin được vào trang /admin/** ko có role ADMIN chuyển về trang chủ
            if (pathName.startsWith('/admin/') && !userRoles.includes("ADMIN")) {
                window.location.href = "http://localhost:8080";

                // chỉ admin và recruiter được vào trang /recruiter/**  ko có role ADMIN hoặc RECRUITER chuyển về trang chủ
            } else if (pathName.startsWith('/recruiter/') && !userRoles.includes("RECRUITER") && !userRoles.includes("ADMIN")) {
                window.location.href = "http://localhost:8080";
            }
        }
    };
</script>
<script>
    // Truy cập vào các thành phần
    const name = document.getElementById("name")
    const title = document.getElementById("title")
    const dueDateTime = document.getElementById("dueDateTime")
    const location = document.getElementById("location")
    const jobStatus = document.getElementById("jobStatus")
    const yoe = document.getElementById("yoe")
    const salaryFrom = document.getElementById("salaryFrom")
    const salaryTo = document.getElementById("salaryTo")
    const literacy = document.getElementById("literacy")
    const benefit = document.getElementById("benefit")
    const detail = document.getElementById("detail")
    const requirement = document.getElementById("requirement")
    const skill = $("#skill");

    skill.select2({
        placeholder: "- Chọn chủ đề",
    });
</script>
<script th:inline="javascript">
    let job = [[${job}]]
    console.log(job)
    console.log("11112222")
    // $.ajax({
    //     url: '/api/v1/jobs/' + [[${job.id}]],
    //     type: 'GET',
    //     success: function (response) {
    //         $('#name').val(response.name);
    //         $('#title').text(response.title);
    //         $('#dueDateTime').val(response.dueDateTime);
    //         $('#location').val(response.location);
    //         $('#jobStatus').val(response.jobStatus);
    //         $('#yoe').val(response.yoe);
    //         $('#salaryFrom').val(response.salaryFrom);
    //         $('#salaryTo').val(response.salaryTo);
    //         $('#literacy').val(response.literacy);
    //         $('#benefit').val(response.benefit);
    //         $('#detail').val(response.detail);
    //         $('#requirement').val(response.requirement);
    //         $('#skill').val(response.skill);
    //         // $('#skill').val(skillId).trigger('change');
    //     },
    //     error: function (xhr, status, error) {
    //         console.log(error);
    //     }
    // });
    $(document).ready(function () {
        $('#update-form').validate({
            onfocusout: false,
            onkeyup: false,
            onclick: false,
            errorPlacement: function (error, element) {
                error.addClass("error-message");
                error.insertAfter(element.parent());
            },
            rules: {
                "name": {
                    required: true,
                    maxlength: 255
                },
                "title": {
                    required: true,
                    maxlength: 255
                },
                "salaryFrom": {
                    required: true,
                    min: 0
                },
                "salaryTo": {
                    required: true,
                },
                "dueDateTime": {
                    required: true,
                },
                "location": {
                    required: true,
                    maxlength: 255
                },
                "introduce": {
                    required: true,
                },
                "benefit": {
                    required: true,
                },
                "jobStatus": {
                    required: true,
                },
                "detail": {
                    required: true,
                },
                "yoe": {
                    required: false,
                    min: 0
                },
                "requirement": {
                    required: true,
                },
            },
            messages: {
                "name": {
                    required: "Bắt buộc nhập tên công việc",
                    maxlength: "Hãy nhập tối đa 255 ký tự"
                },
                "title": {
                    required: "Bắt buộc nhập tiêu đề tuyển dụng",
                    maxlength: "Hãy nhập tối đa 255 ký tự"
                },
                "salaryFrom": {
                    required: "Hãy nhập mức lương từ",
                    min: "Mức lương phải lớn hơn hoặc bằng 0"
                },
                "salaryTo": {
                    required: "Hãy nhập mức lương đến",
                },
                "dueDateTime": {
                    required: "Hãy nhập hạn nộp"
                },
                "location": {
                    required: "Bắt buộc nhập địa điểm",
                    maxlength: "Hãy nhập tối đa 255 ký tự"
                },
                "introduce": {
                    required: "Bắt buộc nhập giới thiệu công việc",
                },
                "benefit": {
                    required: "Bắt buộc nhập quyền lợi công việc",
                },
                "jobStatus": {
                    required: "Bắt buộc chọn trạng thái công việc",
                },
                "detail": {
                    required: "Bắt buộc nhập mô tả công việc",
                },
                "yoe": {
                    required: "Bắt buộc nhập số năm kinh nghiệm",
                    min: "Số năm kinh nghiệm phải lớn hơn hoặc bằng 0"
                },
                "requirement": {
                    required: "Bắt buộc nhập yêu cầu công việc",
                },
            }
        })

        $('.btn-update-job').click(function () {
            const isValidForm = $('#update-form').valid();
            if (!isValidForm) {
                return;
            }

            let title = $("#title").val();
            let name = $("#name").val();
            let location = $("#location").val();
            let skill = $("#skill").val();
            let salaryFrom = $("#salaryFrom").val();
            let salaryTo = $("#salaryTo").val();
            let dueDateTime = $("#dueDateTime").val();
            let introduce = $("#introduce").val();
            let benefit = $("#benefit").val();
            let jobStatus = $("#jobStatus").val();
            let detail = $("#detail").val();
            let literacy = $("#literacy").val();
            let yoe = $("#yoe").val();
            let requirement = $("#requirement").val();

            let request = {
                name: name,
                title: title,
                salaryFrom: salaryFrom,
                salaryTo: salaryTo,
                dueDateTime: dueDateTime,
                location: location,
                skill: skill,
                introduce: introduce,
                benefit: benefit,
                jobStatus: jobStatus,
                detail: detail,
                literacy: literacy,
                yoe: yoe,
                requirement: requirement
            }
            let jwtToken = localStorage.getItem("jwtToken")
            if (jwtToken) {
                $.ajax({
                    url: "/api/v1/jobs/" + [[${job.id}]],
                    type: 'PUT',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(request),
                    headers: {
                        'Authorization': 'Bearer' + " " + jwtToken
                    },
                    success: function (response) {
                        toastr.success("Cập nhật công việc thành công");

                        window.location.href = 'http://localhost:8080/recruiter/jobs'
                    },
                    error: function (data) {
                        toastr.warning(data.responseJSON.message);
                    }
                });
            } else {
                toastr.warning("Bạn chưa đăng nhập")
            }

        });

        $('.btn-delete-job').click(function () {
            confirm("bạn có chắc muốn xóa không")
            $.ajax({
                url: '/api/v1/jobs/' + [[${job.id}]],
                type: 'DELETE',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    toastr.success("Xóa công việc thành công");
                    setTimeout(function () {
                        location.href = "/recruiter/jobs/";
                    }, 1000);
                },
                error: function (data) {
                    toastr.warning(data.responseJSON.message);
                },
            });
        })
    });

</script>
</body>

</html>