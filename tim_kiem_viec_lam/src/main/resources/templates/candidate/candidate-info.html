<!DOCTYPE html>
<html lang="en"
      th:replace="layout/layout :: main-fragment(~{:: title}, ~{:: #css}, ~{:: .candidate-information}, ~{:: #js})">
<head>
    <meta charset="UTF-8">
    <title>TechJobs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
</head>
<body>

<div class="candidate-information">
    <!-- recuiter Nav -->
    <nav class="navbar navbar-expand-lg navbar-light nav-recuitment">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNava"
                aria-controls="navbarNava" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse container" id="navbarNava">

        </div>
    </nav>
    <!--  recuiter Nav -->

    <!-- widget recuitment  -->
    <div class="container-fluid">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="home-ads">
                        <a href="https://www.vietnamworks.com/hrinsider/">
                            <img src="/img/hna2.jpg">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- (end) widget recuitment  -->

    <!-- published recuitment -->
    <div class="container-fluid published-recuitment-wrapper">
        <div class="container published-recuitment-content">
            <div class="row">
                <div class="col-md-8 col-sm-12 col-12 recuitment-inner">
                    <div class="employee-form">

                        <div class="accordion" id="accordionExample">
                            <div class="card recuitment-card">
                                <div class="card-header recuitment-card-header" id="headingOne">
                                    <h2 class="mb-0">
                                        <a class="btn btn-link btn-block text-left recuitment-header" type="button"
                                           data-toggle="collapse" data-target="#collapseOne" aria-expanded="true"
                                           aria-controls="collapseOne">
                                            Thông tin tài khoản
                                            <span id="clickc1_advance2" class="clicksd">
                                                 <i class="fa fa fa-angle-up"></i>
                                            </span>
                                        </a>
                                    </h2>
                                </div>


                                <form id="candidate-update-form">
                                    <div id="collapseOne" class="collapse show" aria-labelledby="headingOne"
                                         data-parent="#accordionExample">

                                        <div class="card-body recuitment-body row">
                                            <div class="col-md-3">
                                                <div class="avatar-upload">
                                                    <img id="recruiter-avatar" class="rounded-circle"
                                                         style="width: 200px; height: 200px" alt="Avatar"
                                                         th:src="${candidate.avatar}"/>
                                                    <input type="file" hidden="hidden" id="avatar-input" name="avatar"
                                                           accept="image/*"/>
                                                </div>
                                            </div>

                                            <div class="col-md-9">
                                                <div class="form-group row">
                                                    <label class="col-sm-3 col-form-label text-right label" for="name">Họ
                                                        tên<span
                                                                style="color: red" class="pl-2">*</span></label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control"
                                                               placeholder="Nhập họ và tên" id="name" name="name">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label class="col-sm-3 col-form-label text-right label" for="phone">Số
                                                        điện
                                                        thoại<span
                                                                style="color: red" class="pl-2">*</span></label>
                                                    <div class="col-sm-9">
                                                        <input type="number" class="form-control" id="phone"
                                                               name="phone">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label class="col-sm-3 col-form-label text-right label"
                                                           for="gender">Giới
                                                        tính<span
                                                                style="color: red" class="pl-2">*</span></label>
                                                    <div class="col-sm-9">
                                                        <select type="text" class="form-control" id="gender"
                                                                name="gender">
                                                            <option value="">Chọn giới tính</option>
                                                            <option value="MALE">MALE</option>
                                                            <option value="FEMALE">FEMALE</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label class="col-sm-3 col-form-label text-right label" for="dob">Ngày
                                                        sinh<span
                                                                style="color: red" class="pl-2">*</span></label>
                                                    <div class="col-sm-9 ">
                                                        <input type="date" class="form-control" id="dob" name="dob">
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="col-sm-3 col-form-label text-right label"
                                                           for="address">Địa
                                                        chỉ
                                                        <span style="color: red" class="pl-2">*</span></label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" id="address"
                                                               name="address">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label class="col-sm-3 col-form-label text-right label"
                                                           for="experience">Kinh nghiệm
                                                    </label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" placeholder=""
                                                               id="experience" name="experience">
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label class="col-sm-3 col-form-label text-right label" for="skill">Kĩ
                                                        năng
                                                    </label>
                                                    <div class="col-sm-9">
                                                        <input type="text" class="form-control" placeholder=""
                                                               id="skill"
                                                               name="skill">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>

                            </div>
                        </div>


                        <div class="rec-submit">
                            <button type="button" class="btn-submit-recuitment mb-3 ml-3" name="">
                                <i class="fa fa-floppy-o pr-2"></i>Lưu Hồ Sơ
                            </button>
                        </div>
                    </div>

                </div>
                <!-- Side bar -->
                <div class="col-md-4 col-sm-12 col-12">
                    <div class="recuiter-info">
                        <div class="recuiter-info-avt">
                            <img th:src="${candidate.avatar}">
                        </div>
                        <div class="clearfix list-rec">
                            <h4 th:text="${candidate.name}"></h4>

                        </div>
                    </div>


                    <div class="block-sidebar" style="margin-bottom: 20px;">
                        <header>
                            <h3 class="title-sidebar font-roboto bg-primary">
                                Trung tâm quản lý
                            </h3>
                        </header>
                        <div class="content-sidebar menu-trung-tam-ql menu-ql-employer">

                            <h3 class="menu-ql-ntv">
                                Việc làm của bạn
                            </h3>
                            <ul>
                                <li><a href="#">Số việc làm đã nộp: <strong th:text="${countApplications}"></strong></a>
                                </li>

                                <li>
                                    <a th:href="@{/applications/{id}(id=${users.id})}" target="_blank">
                                        Việc làm đã ứng tuyển
                                    </a>
                                </li>
                            </ul>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- (end) published recuitment -->

    <div class="clearfix"></div>


</div>
<th:block id="js">


    <script type="text/javascript" src="/js/main.js"></script>
    <script type="text/javascript" src="/jsmain/signin.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-storage.js"></script>

    <script>
        $(document).ready(function () {
            const userInfomationStr = localStorage.getItem("userInfomation");
            if (userInfomationStr) {
                const userInfomation = JSON.parse(userInfomationStr)

                // Ẩn/hiện các thẻ <a> tương ứng
                if (userInfomation.roles[0] === 'USER') {
                    $('#user').hide();
                    $('#recruiter').hide();
                    $('.admin').hide();
                }
            }

        })
    </script>

    <script th:inline="javascript">


        let firebaseConfig = {
            apiKey: "AIzaSyBd79sSD4tMr-HWBxg1zJNJMvG_lVcncx8",
            projectId: "job-hunt-c9d49",
            storageBucket: "job-hunt-c9d49.appspot.com",
        };
        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        // Lấy tham chiếu đến Firebase Storage bucket
        let storage = firebase.storage();
        let storageRef = storage.ref();

        const candidate = [[${candidate}]];

        $("#name").val(candidate.name)
        $("#phone").val(candidate.phone)
        $("#gender").val(candidate.gender)
        $("#dob").val(candidate.dob)
        $("#address").val(candidate.address)
        $("#experience").val(candidate.experience)
        $("#skill").val(candidate.skill)

        $("#candidate-update-form").validate({
            onfocusout: false,
            onkeyup: false,
            onclick: false,
            errorPlacement: function (error, element) {
                error.addClass("error-message");
                error.insertAfter(element.parent());
            },
            rules: {
                "name": {
                    required: true,
                    maxlength: 255
                },
                "phone": {
                    required: true,
                },
                "gender": {
                    required: true,
                },
                "dob": {
                    required: true,
                },
                "address": {
                    required: true,
                    maxlength: 255
                },
                "experience": {
                    required: false,
                },
                "skill": {
                    required: false,
                },
            },
            messages: {
                "name": {
                    required: "Bắt buộc nhập tên",
                    maxlength: "Hãy nhập tối đa 255 ký tự"
                },
                "phone": {
                    required: "Bắt buộc nhập số điện thoại",
                },
                "gender": {
                    required: "Bắt buộc chọn giới tính",
                },
                "dob": {
                    required: "Bắt buộc nhập ngày sinh",
                },
                "address": {
                    required: "Bắt buộc nhập địa chỉ",
                    maxlength: "Hãy nhập tối đa 255 ký tự"
                },
            },
        });

        $("#recruiter-avatar").click(() => {
            $("#avatar-input").click();
        });

        let chosenFile = null;
        $('#avatar-input').change(event => {
            const tempFiles = event.target.files;
            const maxSizeInBytes = 5242880;
            if (!tempFiles || tempFiles.length === 0) {
                return;
            }
            chosenFile = tempFiles[0];
            if (chosenFile && chosenFile.size > maxSizeInBytes) {
                alert("File size exceeded the allowed limit (5MB)!");
                this.value = '';
                return;
            }
            const imageBlob = new Blob([chosenFile], {type: chosenFile.type});
            const imageUrl = URL.createObjectURL(imageBlob);
            $("#recruiter-avatar").attr("src", imageUrl);
        });

        $('.btn-submit-recuitment').click(async function () {
            $(this).prop('disabled', true);

            let isValidForm = $("#candidate-update-form").valid();
            if (!isValidForm) return;


            const name = $("#name").val();
            const phone = $("#phone").val();
            const gender = $("#gender").val();
            const dob = $("#dob").val();
            const address = $("#address").val();
            const experience = $("#experience").val();
            const skill = $("#skill").val();

            const formData = {
                name: name,
                phone: phone,
                gender: gender,
                dob: dob,
                address: address,
                experience: experience,
                skill: skill,
                avatar: candidate.avatar,
            };

            if (chosenFile != null) {
                formData.avatar = await uploadImage(chosenFile)
                updateUser(formData);
            } else {
                updateUser(formData);
            }
        });

        async function uploadImage(chosenFile) {
            try {
                let imageName = chosenFile.name;
                let imageRef = storageRef.child("images/" + imageName);
                let snapshort = await imageRef.put(chosenFile);
                return await snapshort.ref.getDownloadURL();
            } catch (error) {
                throw error;
            }
        }

        function updateUser(formData) {
            $.ajax({
                url: '/api/v1/candidate/' + [[${candidate.id}]],
                type: 'PUT',
                contentType: "application/json",
                data: JSON.stringify(formData),
                success: function () {
                    toastr.success("Thông tin tài khoản đã được cập nhật thành công!!");

                    setTimeout(function () {
                        // saveNewInformation(formData);
                        $('.btn-submit-recuitment').prop('disabled', false);
                        window.location.reload();
                    }, 1000)
                },
                error: function () {
                    toastr.warning("Đã có lỗi xảy ra trong quá trình cập nhật");
                    $('.btn-submit-recuitment').prop('disabled', false);
                }
            })
        }

        // Lấy thông tin người dùng đã đăng nhập từ localStorage
        const userInfomation = JSON.parse(localStorage.getItem("userInfomation"));
        const loggedInEmail = userInfomation.username;

        const userEmail = candidate.user.email   // lấy thông tin email trang
        console.log(userEmail)
        console.log(loggedInEmail)

        if (userEmail !== loggedInEmail) {
            window.location.href = "http://localhost:8080/splash";
        }

    </script>
</th:block>


</body>
</html>